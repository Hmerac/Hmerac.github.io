<!doctype html><html lang=en-us>
<head>
<meta charset=utf-8>
<meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no">
<title>Session Manager - Modern Bastion - Hmerac</title>
<meta name=HandheldFriendly content="True">
<meta name=MobileOptimized content="320">
<meta name=referrer content="no-referrer">
<meta name=description content="Automating Stuff">
<meta property="og:site_name" content="Hmerac">
<meta property="og:locale" content="nn_NO">
<meta property="og:type" content="article">
<meta property="og:url" content="https://mertacikportali.com/blog/2019/session-manager-modern-bastion/">
<meta property="og:title" content="Session Manager - Modern Bastion">
<meta property="og:image" content="https://mertacikportali.com/img/meta/hmerac.png">
<meta property="og:description" content="Automating Stuff">
<meta property="twitter:site" content="@mertacikportali">
<meta property="twitter:title" content="Session Manager - Modern Bastion">
<meta property="twitter:image" content="https://mertacikportali.com/img/meta/hmerac.png">
<meta property="twitter:card" content="summary">
<meta property="twitter:description" content="Automating Stuff">
<link rel=canonical href=https://mertacikportali.com/blog/2019/session-manager-modern-bastion/>
<link href=//cdn.jsdelivr.net/npm/bootstrap@5.0.1/dist/css/bootstrap.min.css rel=stylesheet integrity=sha384-+0n0xVW2eSR5OomGNYDnhzAbDsOXxcvSN1TPprVMTNDbiYZCxYbOOl7+AMvyTG2x crossorigin=anonymous>
<link rel=stylesheet href=https://mertacikportali.com/css/main.css>
<link rel=stylesheet href=https://mertacikportali.com/css/highlight.css>
<link rel=stylesheet href=//cdn.jsdelivr.net/npm/progressively@1.2.5/dist/progressively.min.css integrity="sha256-xbqLYBMsjpuCihs+3Fgp/MFMtPdo2SWKoOjEWOqR4X0=" crossorigin=anonymous>
<link rel="shortcut icon" href=https://mertacikportali.com/img/meta/favicon.ico>
<link href rel=alternate type=application/rss+xml title=Hmerac>
<link href="//fonts.googleapis.com/css?family=Fira+Code|Merriweather+Sans:400,700|Merriweather:400,700&display=swap" rel=stylesheet>
<style>:root{--font-code:"Consolas", monospace;--font-content:"Consolas", monospace;--font-title:"Consolas", monospace}</style>
</head>
<body>
<div class="my-4 my-md-5 header">
<div class=container>
<div class=row>
<div class="col-auto d-none d-md-block">
<a href=https://mertacikportali.com/>
<img class=logo src=https://mertacikportali.com/img/meta/hmerac.png alt=logo>
</a>
</div>
<div class="col-auto align-self-center mr-auto">
<a class=text-decoration-none href=https://mertacikportali.com/>
<h1 class="font-weight-bold name">
Hmerac
</h1>
</a>
<ul class="nav nav-primary">
<li class=nav-item>
<a class="text-uppercase nav-link text-blog" href=/blog/>
Blog
</a>
</li>
</ul>
<ul class="nav nav-secondary">
</ul>
</div>
</div>
</div>
</div>
<div class=content>
<div class=container>
<div class="row justify-content-center">
<div class="col-md-9 col-lg-9">
<h1 class="mx-0 mx-md-4">
Session Manager - Modern Bastion
</h1>
<div class="mb-4 mb-md-5 meta">
<span class=date title="Mon Mar 11 2019 00:00:00 UTC">
March 11, 2019
</span>
<span class="reading-time middot">
4 minutes
</span>
<div class="d-none d-md-inline tags">
<ul class="list-unstyled d-inline">
<li class="d-inline middot">
<a href=/tags/aws>AWS</a>
</li>
</ul>
</div>
<div class="d-none d-md-inline tags">
<ul class="list-unstyled d-inline">
</ul>
</div>
</div>
<div class=markdown>
<h2 id=overview>Overview</h2>
<p>Are you tired of dealing with key pairs? Maybe tired of securing them with KeyPass? Or configuring SSH daemon for ease of use? Don&rsquo;t worry, Systems Manager - Session Manager is here to save you from all these.</p>
<p>Session Manager is announced on 11 September 2018 with this <a href=https://aws.amazon.com/blogs/aws/new-session-manager>here</a>. Seriously, I remember being excited like potatoes thrown into hot oil. Because the process for connecting RDS Instances via Bastion Hosts were literal pain in our workplace. All those SSH private keys, security of them, jumping one from another for again, security reasons&mldr; All I can say is, it was taking long.</p>
<p>At this point, you might say, &ldquo;Why aren&rsquo;t you using a third party UI such as <a href=https://github.com/bastillion-io/Bastillion-EC2>Bastillion EC2</a> for connecting Instances?&rdquo; That&rsquo;s because there are intermediate EC2 Instances  involved with jump process. Complexity is already high, no need to increase it.</p>
<p>Now, you might also say, &ldquo;But you know you can use a tool to add people&rsquo;s IP to the security group of the Instances when they try to connect? Then let&rsquo;s say, after 12 hours, you might remove the IPs from the security group.&rdquo; For curious cats, it is explained in this <a href=https://medium.com/@henriksylvesterpedersen/you-dont-need-that-bastion-host-cd1b1717a9e7>Medium Story</a>. That&rsquo;s an option for sure, but I don&rsquo;t like the idea of changing the state of a resource that much. Needlessly to say, we want immutable infrastructure in the end, right?</p>
<h2 id=session-manager>Session Manager</h2>
<p>Now, let&rsquo;s think about Session Manager solution. Session Manager is an EC2 Instance just like a Bastion Host, but the key difference is, you can access it from AWS Console and also with <a href=https://docs.aws.amazon.com/cli/latest/reference/ssm/start-session.html>CLI API</a>(However, I&rsquo;m going to talk about the Console way). Imagine the possibilities. Another important difference is, it doesn&rsquo;t require any ingress security group rules since you won&rsquo;t be using SSH, in other words, your IP. Only an egress rule with 0.0.0.0/0 is needed if you want to download any package later on.</p>
<p>Now, the process is no-brainer after provisioning your EC2 Instance. You open your console, go to Systems Manager, click Session Manager tab, select your SSM Instance and voila! Now you can access every resource in your VPC as long as their security group allows your connection protocol and port. Let&rsquo;s do a hands-on presentation!</p>
<h2 id=provision-session-manager-instance>Provision Session Manager Instance</h2>
<ol>
<li>Select an AMI which has pre-installed SSM Agent. I choose <a href=https://aws.amazon.com/amazon-linux-ami/2018.03-release-notes>ami-07f1aa69c7c7b01c9</a> since it satisfies my requirements. Notice that this AMI belongs to eu-central-1(Frankfurt).</li>
</ol>
<p><figure class=progressive><img class="progressive__img progressive--not-loaded" data-progressive=https://mertacikportali.com/img/2019/Capture1.png src=https://mertacikportali.com/img/2019/low/Capture1.png alt='alt="image"'></p></figure>
<ol start=2>
<li>I choose t2.micro as Instance type since we are experimenting. On some operations, you might want to provision more powerful machines. These operations include, taking DB dumps, restoring DBs, data processing etc. which need more IOPS, CPU and network power.</li>
</ol>
<p><figure class=progressive><img class="progressive__img progressive--not-loaded" data-progressive=https://mertacikportali.com/img/2019/Capture2-1.png src=https://mertacikportali.com/img/2019/low/Capture2-1.png alt='alt="image"'></p></figure>
<ol start=3>
<li>Next, we choose our VPC, private subnet and IAM role for the Instance. Role is important here, because without <a href=https://docs.aws.amazon.com/systems-manager/latest/userguide/getting-started-add-permissions-to-existing-profile.html>required permissions</a>, you can&rsquo;t start a session and each operation done in SSM Instance has its own permission, as you can guess.</li>
</ol>
<p><figure class=progressive><img class="progressive__img progressive--not-loaded" data-progressive=https://mertacikportali.com/img/2019/Capture7.png src=https://mertacikportali.com/img/2019/low/Capture7.png alt='alt="image"'></p></figure>
<ol start=4>
<li>Now, I configure bootstrap script to set region to eu-central-1, install psql package, and upgrade awscli.</li>
</ol>
<p><figure class=progressive><img class="progressive__img progressive--not-loaded" data-progressive=https://mertacikportali.com/img/2019/Capture3.png src=https://mertacikportali.com/img/2019/low/Capture3.png alt='alt="image"'></p></figure>
<ol start=5>
<li>Skipping volume step&mldr;</li>
<li>Adding &ldquo;Name&rdquo; tag</li>
</ol>
<p><figure class=progressive><img class="progressive__img progressive--not-loaded" data-progressive=https://mertacikportali.com/img/2019/Capture4.png src=https://mertacikportali.com/img/2019/low/Capture4.png alt='alt="image"'></p></figure>
<ol start=7>
<li>Now, the best part. I only add one egress rule for Internet Access. Nothing else is needed. This allows better security than opening port 22 for SSH&rsquo;ing your bastion.</li>
</ol>
<p><figure class=progressive><img class="progressive__img progressive--not-loaded" data-progressive=https://mertacikportali.com/img/2019/Capture5.png src=https://mertacikportali.com/img/2019/low/Capture5.png alt='alt="image"'></p></figure>
<ol start=8>
<li>I don&rsquo;t create or choose any key-pairs since this is only experiment and we shouldn&rsquo;t need any keys to access our SSM Instance. Of course, you can create one if you want to.</li>
<li>LAUNCH!</li>
</ol>
<h2 id=testing-ssm-instance>Testing SSM Instance</h2>
<p>As I mentioned before, open your console, go to Systems Manager, click Session Manager tab, click on Start Session, select our Instance &ldquo;TestSSM&rdquo; and click on Start Session again.</p>
<p><figure class=progressive><img class="progressive__img progressive--not-loaded" data-progressive=https://mertacikportali.com/img/2019/Capture6.png src=https://mertacikportali.com/img/2019/low/Capture6.png alt='alt="image"'></p></figure>
<p>You should now see a shell inside your browser! Let&rsquo;s try to connect to one of our PostgreSQL RDS Instances.</p>
<p><figure class=progressive><img class="progressive__img progressive--not-loaded" data-progressive=https://mertacikportali.com/img/2019/Capture8.png src=https://mertacikportali.com/img/2019/low/Capture8.png alt='alt="image"'></p></figure>
<p>As you can see, you have your own secure, easy to configure, easy to use bastion at this point.</p>
<h2 id=monitoring-and-auiditing-ssm-bastion>Monitoring and Auiditing SSM Bastion</h2>
<p>At this point, you might ask, can I log who&rsquo;s using this SSM Bastion and what they are doing? Of course <a href=https://docs.aws.amazon.com/systems-manager/latest/userguide/session-manager-logging-auditing.html>you can</a>. Under &ldquo;Preferences&rdquo; section in &ldquo;Session Manager&rdquo; tab, you can stream SSM Bastion&rsquo;s activities to your specified CloudWatch Logs Stream or S3 Bucket.</p>
<p><figure class=progressive><img class="progressive__img progressive--not-loaded" data-progressive=https://mertacikportali.com/img/2019/Capture9.png src=https://mertacikportali.com/img/2019/low/Capture9.png alt='alt="image"'></p></figure>
<p><strong>References & Documentation:</strong></p>
<ul>
<li><a href=https://docs.aws.amazon.com/systems-manager/latest/userguide/session-manager.html>https://docs.aws.amazon.com/systems-manager/latest/userguide/session-manager.html</a></li>
<li><a href=https://docs.aws.amazon.com/cli/latest/reference/ssm/start-session.html>https://docs.aws.amazon.com/cli/latest/reference/ssm/start-session.html</a></li>
</ul>
</div>
</div>
<div class="col-sm-12 col-md-3">
<nav id=TableOfContents class=sticky-top>
<ul>
<li><a href=#overview>Overview</a></li>
<li><a href=#session-manager>Session Manager</a></li>
<li><a href=#provision-session-manager-instance>Provision Session Manager Instance</a></li>
<li><a href=#testing-ssm-instance>Testing SSM Instance</a></li>
<li><a href=#monitoring-and-auiditing-ssm-bastion>Monitoring and Auiditing SSM Bastion</a></li>
</ul>
</nav>
</div>
</div>
<div class=row>
<div class="col-md-9 col-lg-9">
<div class=navigation>
<div class=row>
<div class="col-12 col-md-6">
</div>
<div class="col-12 col-md-6">
<div class="mx-0 mx-md-4 mt-4 text-end">
<a href=https://mertacikportali.com/blog/2019/snapshot-restore-pg-restore/>
<span class=text>Snapshot Restore versus pg_restore – Time Comparison</span>
<span class=icon><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 477.175 477.175"><path d="M360.731 229.075l-225.1-225.1c-5.3-5.3-13.8-5.3-19.1.0s-5.3 13.8.0 19.1l215.5 215.5-215.5 215.5c-5.3 5.3-5.3 13.8.0 19.1 2.6 2.6 6.1 4 9.5 4s6.9-1.3 9.5-4l225.1-225.1C365.931 242.875 365.931 234.275 360.731 229.075z"/></svg>
</span>
</a>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="my-4 footer">
<div class=container>
<div class="row justify-content-center">
<div class="col-sm-12 col-md-6 col-lg-5">
<div class="mx-0 mx-md-4 mb-2 text-center text-md-start">
<div>
<a class="mx-1 mr-md-2 ml-md-0 text-tags" href=/tags/>
Tags
</a>
</div>
<a href=https://mertacikportali.com>© 2022 by Mert Acikportali</a>
</div>
</div>
<div class="col-sm-12 col-md-6 col-lg-5">
<div class="mx-0 mx-md-4 text-center text-md-end">
<a href=https://github.com/hmerac target=_blank class="mx-1 ml-md-2 mr-md-0 icon" aria-label=GitHub><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" fill-rule="evenodd" clip-rule="evenodd" stroke-linejoin="round" stroke-miterlimit="1.414"><path d="M8 0C3.58.0.0 3.582.0 8c0 3.535 2.292 6.533 5.47 7.59.4.075.547-.172.547-.385.0-.19-.007-.693-.01-1.36-2.226.483-2.695-1.073-2.695-1.073-.364-.924-.89-1.17-.89-1.17-.725-.496.056-.486.056-.486.803.056 1.225.824 1.225.824.714 1.223 1.873.87 2.33.665.072-.517.278-.87.507-1.07-1.777-.2-3.644-.888-3.644-3.953.0-.873.31-1.587.823-2.147-.09-.202-.36-1.015.07-2.117.0.0.67-.215 2.2.82.64-.178 1.32-.266 2-.27.68.004 1.36.092 2 .27 1.52-1.035 2.19-.82 2.19-.82.43 1.102.16 1.915.08 2.117.51.56.82 1.274.82 2.147.0 3.073-1.87 3.75-3.65 3.947.28.24.54.73.54 1.48.0 1.07-.01 1.93-.01 2.19.0.21.14.46.55.38C13.71 14.53 16 11.53 16 8c0-4.418-3.582-8-8-8"/></svg>
</a>
<a href=https://twitter.com/mertacikportali target=_blank class="mx-1 ml-md-2 mr-md-0 icon" aria-label=Twitter><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" fill-rule="evenodd" clip-rule="evenodd" stroke-linejoin="round" stroke-miterlimit="1.414"><path d="M16 3.038c-.59.26-1.22.437-1.885.517.677-.407 1.198-1.05 1.443-1.816-.634.37-1.337.64-2.085.79-.598-.64-1.45-1.04-2.396-1.04-1.812.0-3.282 1.47-3.282 3.28.0.26.03.51.085.75-2.728-.13-5.147-1.44-6.766-3.42C.83 2.58.67 3.14.67 3.75c0 1.14.58 2.143 1.46 2.732-.538-.017-1.045-.165-1.487-.41v.04c0 1.59 1.13 2.918 2.633 3.22-.276.074-.566.114-.865.114-.21.0-.41-.02-.61-.058.42 1.304 1.63 2.253 3.07 2.28-1.12.88-2.54 1.404-4.07 1.404-.26.0-.52-.015-.78-.045 1.46.93 3.18 1.474 5.04 1.474 6.04.0 9.34-5 9.34-9.33.0-.14.0-.28-.01-.42.64-.46 1.2-1.04 1.64-1.7z" fill-rule="nonzero"/></svg>
</a>
<a href=https://t.me/hmerac target=_blank class="mx-1 ml-md-2 mr-md-0 icon" aria-label=Telegram><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 240 240"><circle cx="120" cy="120" r="120"/><path fill="#c8daea" d="m98 175c-3.8876.0-3.227-1.4679-4.5678-5.1695L82 132.2059 170 80"/><path fill="#a9c9dd" d="m98 175c3 0 4.3255-1.372 6-3l16-15.558-19.958-12.035"/><path fill="#eff7fc" d="m100.04 144.41 48.36 35.729c5.5185 3.0449 9.5014 1.4684 10.876-5.1235l19.685-92.763c2.0154-8.0802-3.0801-11.745-8.3594-9.3482l-115.59 44.571c-7.8901 3.1647-7.8441 7.5666-1.4382 9.528l29.663 9.2583 68.673-43.325c3.2419-1.9659 6.2173-.90899 3.7752 1.2584"/></svg>
</a>
<a href=https://www.linkedin.com/in/mertacikportali target=_blank class="mx-1 ml-md-2 mr-md-0 icon" aria-label=Linkedin><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" fill-rule="evenodd" clip-rule="evenodd" stroke-linejoin="round" stroke-miterlimit="1.414"><path d="M13.632 13.635h-2.37V9.922c0-.886-.018-2.025-1.234-2.025-1.235.0-1.424.964-1.424 1.96v3.778h-2.37V6H8.51v1.04h.03c.318-.6 1.092-1.233 2.247-1.233 2.4.0 2.845 1.58 2.845 3.637v4.188zM3.558 4.955c-.762.0-1.376-.617-1.376-1.377.0-.758.614-1.375 1.376-1.375.76.0 1.376.617 1.376 1.375.0.76-.617 1.377-1.376 1.377zm1.188 8.68H2.37V6h2.376v7.635zM14.816.0H1.18C.528.0.0.516.0 1.153v13.694C0 15.484.528 16 1.18 16h13.635c.652.0 1.185-.516 1.185-1.153V1.153C16 .516 15.467.0 14.815.0z" fill-rule="nonzero"/></svg>
</a>
<a href=mailto:mertacikportali@gmail.com class="mx-1 ml-md-2 mr-md-0 icon" aria-label=Email><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 14 16"><path d="M0 4v8c0 .55.45 1 1 1h12c.55.0 1-.45 1-1V4c0-.55-.45-1-1-1H1c-.55.0-1 .45-1 1zm13 0L7 9 1 4h12zM1 5.5l4 3-4 3v-6zM2 12l3.5-3L7 10.5 8.5 9l3.5 3H2zm11-.5-4-3 4-3v6z"/></svg>
</a>
<a href class="mx-1 ml-md-2 mr-md-0 icon" aria-label=RSS><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" fill-rule="evenodd" clip-rule="evenodd" stroke-linejoin="round" stroke-miterlimit="1.414"><path d="M12.8 16C12.8 8.978 7.022 3.2.0 3.2V0c8.777.0 16 7.223 16 16h-3.2zM2.194 11.61c1.21.0 2.195.985 2.195 2.196.0 1.21-.99 2.194-2.2 2.194C.98 16 0 15.017.0 13.806c0-1.21.983-2.195 2.194-2.195zM10.606 16h-3.11c0-4.113-3.383-7.497-7.496-7.497v-3.11c5.818.0 10.606 4.79 10.606 10.607z"/></svg>
</a>
</div>
</div>
</div>
</div>
</div>
<script src=//cdn.jsdelivr.net/npm/bootstrap@5.0.1/dist/js/bootstrap.bundle.min.js integrity=sha384-gtEjrD/SeCtmISkJkNUaaKMoLD0//ElJ19smozuHV6z3Iehds+3Ulb9Bn9Plx0x4 crossorigin=anonymous></script>
<script src=//cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.0.1/build/highlight.min.js></script>
<script src=//cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.0.1/build/languages/bash.min.js defer></script>
<script src=//cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.0.1/build/languages/terraform.min.js defer></script>
<script src=//cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.0.1/build/languages/yaml.min.js defer></script>
<script src=//cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.0.1/build/languages/go.min.js defer></script>
<script src=//cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.0.1/build/languages/gradle.min.js defer></script>
<script src=//cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.0.1/build/languages/groovy.min.js defer></script>
<script src=//cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.0.1/build/languages/java.min.js defer></script>
<script src=//cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.0.1/build/languages/makefile.min.js defer></script>
<script src=//cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.0.1/build/languages/nginx.min.js defer></script>
<script src=//cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.0.1/build/languages/dockerfile.min.js defer></script>
<script>window.addEventListener('load',function(){hljs.highlightAll()},!0)</script>
<script src=//cdn.jsdelivr.net/npm/progressively@1.2.5/dist/progressively.min.js integrity="sha256-LvFVlLdfGI3WeEH+8Ni4kxLm02g2GlOfeGCGLXfRk/U=" crossorigin=anonymous></script>
<script>window.addEventListener('load',function(){progressively.init({delay:30,throttle:50})},!0)</script>
</body>
</html>