<!doctype html><html lang=en-us>
<head>
<meta charset=utf-8>
<meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no">
<title>Snapshot Restore versus pg_restore â€“ Time Comparison - Hmerac</title>
<meta name=HandheldFriendly content="True">
<meta name=MobileOptimized content="320">
<meta name=referrer content="no-referrer">
<meta name=description content="Automating Stuff">
<meta property="og:site_name" content="Hmerac">
<meta property="og:locale" content="nn_NO">
<meta property="og:type" content="article">
<meta property="og:url" content="https://mertacikportali.com/blog/2019/snapshot-restore-pg-restore/">
<meta property="og:title" content="Snapshot Restore versus pg_restore â€“ Time Comparison">
<meta property="og:image" content="https://mertacikportali.com/img/meta/hmerac.png">
<meta property="og:description" content="Automating Stuff">
<meta property="twitter:site" content="@mertacikportali">
<meta property="twitter:title" content="Snapshot Restore versus pg_restore â€“ Time Comparison">
<meta property="twitter:image" content="https://mertacikportali.com/img/meta/hmerac.png">
<meta property="twitter:card" content="summary">
<meta property="twitter:description" content="Automating Stuff">
<link rel=canonical href=https://mertacikportali.com/blog/2019/snapshot-restore-pg-restore/>
<link href=//cdn.jsdelivr.net/npm/bootstrap@5.0.1/dist/css/bootstrap.min.css rel=stylesheet integrity=sha384-+0n0xVW2eSR5OomGNYDnhzAbDsOXxcvSN1TPprVMTNDbiYZCxYbOOl7+AMvyTG2x crossorigin=anonymous>
<link rel=stylesheet href=https://mertacikportali.com/css/main.css>
<link rel=stylesheet href=https://mertacikportali.com/css/highlight.css>
<link rel=stylesheet href=//cdn.jsdelivr.net/npm/progressively@1.2.5/dist/progressively.min.css integrity="sha256-xbqLYBMsjpuCihs+3Fgp/MFMtPdo2SWKoOjEWOqR4X0=" crossorigin=anonymous>
<link rel="shortcut icon" href=https://mertacikportali.com/img/meta/favicon.ico>
<link href rel=alternate type=application/rss+xml title=Hmerac>
<link href="//fonts.googleapis.com/css?family=Fira+Code|Merriweather+Sans:400,700|Merriweather:400,700&display=swap" rel=stylesheet>
<style>:root{--font-code:"Consolas", monospace;--font-content:"Consolas", monospace;--font-title:"Consolas", monospace}</style>
</head>
<body>
<div class="my-4 my-md-5 header">
<div class=container>
<div class=row>
<div class="col-auto d-none d-md-block">
<a href=https://mertacikportali.com/>
<img class=logo src=https://mertacikportali.com/img/meta/hmerac.png alt=logo>
</a>
</div>
<div class="col-auto align-self-center mr-auto">
<a class=text-decoration-none href=https://mertacikportali.com/>
<h1 class="font-weight-bold name">
Hmerac
</h1>
</a>
<ul class="nav nav-primary">
<li class=nav-item>
<a class="text-uppercase nav-link text-blog" href=/blog/>
Blog
</a>
</li>
</ul>
<ul class="nav nav-secondary">
</ul>
</div>
</div>
</div>
</div>
<div class=content>
<div class=container>
<div class="row justify-content-center">
<div class="col-md-9 col-lg-9">
<h1 class="mx-0 mx-md-4">
Snapshot Restore versus pg_restore â€“ Time Comparison
</h1>
<div class="mb-4 mb-md-5 meta">
<span class=date title="Wed Mar 13 2019 00:00:00 UTC">
March 13, 2019
</span>
<span class="reading-time middot">
4 minutes
</span>
<div class="d-none d-md-inline tags">
<ul class="list-unstyled d-inline">
<li class="d-inline middot">
<a href=/tags/postgres>postgres</a>
</li>
<li class="d-inline middot">
<a href=/tags/database>database</a>
</li>
<li class="d-inline middot">
<a href=/tags/aws>AWS</a>
</li>
<li class="d-inline middot">
<a href=/tags/comparison>comparison</a>
</li>
</ul>
</div>
<div class="d-none d-md-inline tags">
<ul class="list-unstyled d-inline">
</ul>
</div>
</div>
<div class=markdown>
<h2 id=summary>Summary</h2>
<p>I&rsquo;ll just cut to the chase here and give detailed analysis immediately after.</p>
<p>The time difference between <strong>pg_restoring</strong> an <strong>11GB</strong> sized PostgreSQL database with <strong>159MB pg_dump</strong> file, versus <strong>restoring snapshot</strong> of itsÂ <strong>t2.medium</strong> RDS Instance:</p>
<p><figure class=progressive><img class="progressive__img progressive--not-loaded" data-progressive=https://mertacikportali.com/img/2019/time_table-1.png src=https://mertacikportali.com/img/2019/low/time_table-1.png alt='alt="image"'></p></figure>
<h2 id=analysis>Analysis</h2>
<blockquote>
<p>Important note! The time values are subject to change, because it depends on network, other running processes, intermediary EC2 Instance type etc.</p>
</blockquote>
<h3 id=pg_restore>pg_restore</h3>
<blockquote>
<p>I used a <strong>t2.medium</strong> SSM Bastion Instance to execute PostgreSQL commands. As I&rsquo;ve mentioned before, provisioning a more powerful EC2 Instance might increase the performance drastically. You can find information about SSM Bastions in <a href=https://www.mertacikportali.com/blog/2019/session-manager-modern-bastion>this page</a>.</p>
</blockquote>
<p>Imagine you have a PostgreSQL database named &ldquo;XXX&rdquo;; with <strong>11 GB size</strong>. Don&rsquo;t get distracted with the name, I don&rsquo;t know why I named it &ldquo;XXX&rdquo;; at the first hand, but here we go anyway ðŸ™‚</p>
<p><figure class=progressive><img class="progressive__img progressive--not-loaded" data-progressive=https://mertacikportali.com/img/2019/rds1.png src=https://mertacikportali.com/img/2019/low/rds1.png alt='alt="image"'></p></figure>
<p>I take dump of it by this <strong>pg_dump</strong> command (check the documentation <a href=https://www.postgresql.org/docs/10/app-pgdump.html>here</a>)</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>PGPASSWORD<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;${PGPASSWORD}&#39;</span> pg_dump -h <span style=color:#e6db74>&#34;restore-test.xxxxxxxxxxxx.eu-central-1.rds.amazonaws.com&#34;</span> -p <span style=color:#ae81ff>54321</span> XXX XXX --format<span style=color:#f92672>=</span>c &amp;gt; xxx.sql
</code></pre></div><p>And to see how big the file is, I execute;</p>
<p><figure class=progressive><img class="progressive__img progressive--not-loaded" data-progressive=https://mertacikportali.com/img/2019/rds3-1.png src=https://mertacikportali.com/img/2019/low/rds3-1.png alt='alt="image"'></p></figure>
<p>You can see that the <strong>xxx.sql</strong> dump file is <strong>159 MB</strong>.</p>
<blockquote>
<p><em>The reason why our dump file is smaller than our XXX database is because we take logical backup of the database, therefore, all of those empty pages, old versions of rows, indexes aren&rsquo;t going to be included in the dump file. It is also compressed as default, because we used</em> <em><strong>-format=c</strong></em> <em>option. All that greatly reduced the size.</em></p>
</blockquote>
<p>Now, let&rsquo;s restore our database with this dump file by this <strong>pg_restore</strong> command (check documentation <a href=https://www.postgresql.org/docs/9.2/app-pgrestore.html>here</a>)</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>PGPASSWORD<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;${PGPASSWORD}&#39;</span> pg_restore -v -h <span style=color:#e6db74>&#34;restore-test.xxxxxxxxxxxx.eu-central-1.rds.amazonaws.com&#34;</span> -p <span style=color:#ae81ff>5432</span> XXX -d POSTGRESQL -j <span style=color:#ae81ff>4</span> -O -C <span style=color:#e6db74>&#34;xxx.sql&#34;</span>
</code></pre></div><p>As you can see, I used <strong>time</strong> command with the actual command, so that we can see how long it took;</p>
<p><figure class=progressive><img class="progressive__img progressive--not-loaded" data-progressive=https://mertacikportali.com/img/2019/rds6.png src=https://mertacikportali.com/img/2019/low/rds6.png alt='alt="image"'></p></figure>
<p><strong>&ldquo;real&rdquo;</strong> value here is what we must be looking for. Details over <a href=https://stackoverflow.com/questions/556405/what-do-real-user-and-sys-mean-in-the-output-of-time1>here</a>. Not bad, huh? However, it is still 14 minutes of downtime, which I don&rsquo;t recommend for your mental, and probably physical health ðŸ™‚ Let&rsquo;s note the value and proceed with <strong>Snapshot Restore</strong> operation.</p>
<h2 id=snapshot-restore>Snapshot Restore</h2>
<p>I took a snapshot of our PostgreSQL RDS Instance, which has our prey, XXX database;</p>
<p><figure class=progressive><img class="progressive__img progressive--not-loaded" data-progressive=https://mertacikportali.com/img/2019/rds4.png src=https://mertacikportali.com/img/2019/low/rds4.png alt='alt="image"'></p></figure>
<p>At this point, if you&rsquo;ve decided to use snapshot restore operation instead of pg_restore, you&rsquo;re going to need to <strong>change your corrupted RDS Instance&rsquo;s identifier</strong>. Because AWS doesn&rsquo;t allow duplicate RDS identifiers, obviously. I mean, they&rsquo;re identifiers, that&rsquo;s what they do, identify. You can change identifier to, let&rsquo;s say, <strong>&ldquo;original-old&rdquo;;</strong>. So the time it takes to change identifier of a <strong>Multi-AZ</strong> RDS Instance is this;</p>
<p><figure class=progressive><img class="progressive__img progressive--not-loaded" data-progressive=https://mertacikportali.com/img/2019/rds10.png src=https://mertacikportali.com/img/2019/low/rds10.png alt='alt="image"'></p></figure>
<p>Quite long. After changing our corrupted RDS Instance&rsquo;s identifier, we can now proceed to <strong>restore our snapshot</strong> and <strong>name it as our original RDS identifier</strong>, so our <strong>applications can automatically connect</strong> to it. Let&rsquo;s see how long it takes to restore a <strong>Multi-AZ</strong> PostgreSQL RDS Instance;</p>
<p><figure class=progressive><img class="progressive__img progressive--not-loaded" data-progressive=https://mertacikportali.com/img/2019/rds8.png src=https://mertacikportali.com/img/2019/low/rds8.png alt='alt="image"'></p></figure>
<p><strong>WOW!</strong> This is not good at all. 20 minutes is enough time to make you looking for a new job! Add that <strong>identifier change time(2:21)</strong> to this and you get <strong>22:04</strong> minutes! You might as well take a damn nap while this completes.</p>
<h2 id=conclusion>Conclusion</h2>
<p>Obviously, the first thing to do is, enabling Multi-AZ feature of your RDS Instances. Because in case of a failure in an availability zone, AWS will automatically change RDS Instance&rsquo;s DNS to a different RDS Instance in a different availability zone. That way, your RDS Instances are fault tolerant.</p>
<p>After enabling Multi-AZ feature, I highly recommend taking pg_dumps of your PostgreSQL Databases daily and uploading them to S3. Even if you don&rsquo;t use PostgreSQL, you can adapt this solution to MySQL etc.</p>
<p>I also highly recommend <a href=https://docs.aws.amazon.com/AmazonRDS/latest/UserGuide/USER_ReadRepl.html>configuring read-replicas</a>(slaves) of the master RDS Instance, if you are swimming in gold and don&rsquo;t feel lazy at all. Because in that case, you can make one of the slaves your master DB and keep your job in some specific disaster scenarios. In addition being a recovery solution for disaster cases, if designed well, it also increases R/W performance drastically.</p>
</div>
</div>
<div class="col-sm-12 col-md-3">
<nav id=TableOfContents class=sticky-top>
<ul>
<li><a href=#summary>Summary</a></li>
<li><a href=#analysis>Analysis</a>
<ul>
<li><a href=#pg_restore>pg_restore</a></li>
</ul>
</li>
<li><a href=#snapshot-restore>Snapshot Restore</a></li>
<li><a href=#conclusion>Conclusion</a></li>
</ul>
</nav>
</div>
</div>
<div class=row>
<div class="col-md-9 col-lg-9">
<div class=navigation>
<div class=row>
<div class="col-12 col-md-6">
<div class="mx-0 mx-md-4 mt-4 text-start">
<a href=https://mertacikportali.com/blog/2019/session-manager-modern-bastion/>
<span class=icon><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 477.175 477.175"><path d="M145.188 238.575l215.5-215.5c5.3-5.3 5.3-13.8.0-19.1s-13.8-5.3-19.1.0l-225.1 225.1c-5.3 5.3-5.3 13.8.0 19.1l225.1 225c2.6 2.6 6.1 4 9.5 4s6.9-1.3 9.5-4c5.3-5.3 5.3-13.8.0-19.1l-215.4-215.5z"/></svg>
</span>
<span class=text>Session Manager - Modern Bastion</span>
</a>
</div>
</div>
<div class="col-12 col-md-6">
<div class="mx-0 mx-md-4 mt-4 text-end">
<a href=https://mertacikportali.com/blog/2020/a-milestone/>
<span class=text>A Milestone</span>
<span class=icon><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 477.175 477.175"><path d="M360.731 229.075l-225.1-225.1c-5.3-5.3-13.8-5.3-19.1.0s-5.3 13.8.0 19.1l215.5 215.5-215.5 215.5c-5.3 5.3-5.3 13.8.0 19.1 2.6 2.6 6.1 4 9.5 4s6.9-1.3 9.5-4l225.1-225.1C365.931 242.875 365.931 234.275 360.731 229.075z"/></svg>
</span>
</a>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="my-4 footer">
<div class=container>
<div class="row justify-content-center">
<div class="col-sm-12 col-md-6 col-lg-5">
<div class="mx-0 mx-md-4 mb-2 text-center text-md-start">
<div>
<a class="mx-1 mr-md-2 ml-md-0 text-tags" href=/tags/>
Tags
</a>
</div>
<a href=https://mertacikportali.com>Â© 2022 by Mert Acikportali</a>
</div>
</div>
<div class="col-sm-12 col-md-6 col-lg-5">
<div class="mx-0 mx-md-4 text-center text-md-end">
<a href=https://github.com/hmerac target=_blank class="mx-1 ml-md-2 mr-md-0 icon" aria-label=GitHub><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" fill-rule="evenodd" clip-rule="evenodd" stroke-linejoin="round" stroke-miterlimit="1.414"><path d="M8 0C3.58.0.0 3.582.0 8c0 3.535 2.292 6.533 5.47 7.59.4.075.547-.172.547-.385.0-.19-.007-.693-.01-1.36-2.226.483-2.695-1.073-2.695-1.073-.364-.924-.89-1.17-.89-1.17-.725-.496.056-.486.056-.486.803.056 1.225.824 1.225.824.714 1.223 1.873.87 2.33.665.072-.517.278-.87.507-1.07-1.777-.2-3.644-.888-3.644-3.953.0-.873.31-1.587.823-2.147-.09-.202-.36-1.015.07-2.117.0.0.67-.215 2.2.82.64-.178 1.32-.266 2-.27.68.004 1.36.092 2 .27 1.52-1.035 2.19-.82 2.19-.82.43 1.102.16 1.915.08 2.117.51.56.82 1.274.82 2.147.0 3.073-1.87 3.75-3.65 3.947.28.24.54.73.54 1.48.0 1.07-.01 1.93-.01 2.19.0.21.14.46.55.38C13.71 14.53 16 11.53 16 8c0-4.418-3.582-8-8-8"/></svg>
</a>
<a href=https://twitter.com/mertacikportali target=_blank class="mx-1 ml-md-2 mr-md-0 icon" aria-label=Twitter><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" fill-rule="evenodd" clip-rule="evenodd" stroke-linejoin="round" stroke-miterlimit="1.414"><path d="M16 3.038c-.59.26-1.22.437-1.885.517.677-.407 1.198-1.05 1.443-1.816-.634.37-1.337.64-2.085.79-.598-.64-1.45-1.04-2.396-1.04-1.812.0-3.282 1.47-3.282 3.28.0.26.03.51.085.75-2.728-.13-5.147-1.44-6.766-3.42C.83 2.58.67 3.14.67 3.75c0 1.14.58 2.143 1.46 2.732-.538-.017-1.045-.165-1.487-.41v.04c0 1.59 1.13 2.918 2.633 3.22-.276.074-.566.114-.865.114-.21.0-.41-.02-.61-.058.42 1.304 1.63 2.253 3.07 2.28-1.12.88-2.54 1.404-4.07 1.404-.26.0-.52-.015-.78-.045 1.46.93 3.18 1.474 5.04 1.474 6.04.0 9.34-5 9.34-9.33.0-.14.0-.28-.01-.42.64-.46 1.2-1.04 1.64-1.7z" fill-rule="nonzero"/></svg>
</a>
<a href=https://t.me/hmerac target=_blank class="mx-1 ml-md-2 mr-md-0 icon" aria-label=Telegram><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 240 240"><circle cx="120" cy="120" r="120"/><path fill="#c8daea" d="m98 175c-3.8876.0-3.227-1.4679-4.5678-5.1695L82 132.2059 170 80"/><path fill="#a9c9dd" d="m98 175c3 0 4.3255-1.372 6-3l16-15.558-19.958-12.035"/><path fill="#eff7fc" d="m100.04 144.41 48.36 35.729c5.5185 3.0449 9.5014 1.4684 10.876-5.1235l19.685-92.763c2.0154-8.0802-3.0801-11.745-8.3594-9.3482l-115.59 44.571c-7.8901 3.1647-7.8441 7.5666-1.4382 9.528l29.663 9.2583 68.673-43.325c3.2419-1.9659 6.2173-.90899 3.7752 1.2584"/></svg>
</a>
<a href=https://www.linkedin.com/in/mertacikportali target=_blank class="mx-1 ml-md-2 mr-md-0 icon" aria-label=Linkedin><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" fill-rule="evenodd" clip-rule="evenodd" stroke-linejoin="round" stroke-miterlimit="1.414"><path d="M13.632 13.635h-2.37V9.922c0-.886-.018-2.025-1.234-2.025-1.235.0-1.424.964-1.424 1.96v3.778h-2.37V6H8.51v1.04h.03c.318-.6 1.092-1.233 2.247-1.233 2.4.0 2.845 1.58 2.845 3.637v4.188zM3.558 4.955c-.762.0-1.376-.617-1.376-1.377.0-.758.614-1.375 1.376-1.375.76.0 1.376.617 1.376 1.375.0.76-.617 1.377-1.376 1.377zm1.188 8.68H2.37V6h2.376v7.635zM14.816.0H1.18C.528.0.0.516.0 1.153v13.694C0 15.484.528 16 1.18 16h13.635c.652.0 1.185-.516 1.185-1.153V1.153C16 .516 15.467.0 14.815.0z" fill-rule="nonzero"/></svg>
</a>
<a href=mailto:mertacikportali@gmail.com class="mx-1 ml-md-2 mr-md-0 icon" aria-label=Email><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 14 16"><path d="M0 4v8c0 .55.45 1 1 1h12c.55.0 1-.45 1-1V4c0-.55-.45-1-1-1H1c-.55.0-1 .45-1 1zm13 0L7 9 1 4h12zM1 5.5l4 3-4 3v-6zM2 12l3.5-3L7 10.5 8.5 9l3.5 3H2zm11-.5-4-3 4-3v6z"/></svg>
</a>
<a href class="mx-1 ml-md-2 mr-md-0 icon" aria-label=RSS><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" fill-rule="evenodd" clip-rule="evenodd" stroke-linejoin="round" stroke-miterlimit="1.414"><path d="M12.8 16C12.8 8.978 7.022 3.2.0 3.2V0c8.777.0 16 7.223 16 16h-3.2zM2.194 11.61c1.21.0 2.195.985 2.195 2.196.0 1.21-.99 2.194-2.2 2.194C.98 16 0 15.017.0 13.806c0-1.21.983-2.195 2.194-2.195zM10.606 16h-3.11c0-4.113-3.383-7.497-7.496-7.497v-3.11c5.818.0 10.606 4.79 10.606 10.607z"/></svg>
</a>
</div>
</div>
</div>
</div>
</div>
<script src=//cdn.jsdelivr.net/npm/bootstrap@5.0.1/dist/js/bootstrap.bundle.min.js integrity=sha384-gtEjrD/SeCtmISkJkNUaaKMoLD0//ElJ19smozuHV6z3Iehds+3Ulb9Bn9Plx0x4 crossorigin=anonymous></script>
<script src=//cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.0.1/build/highlight.min.js></script>
<script src=//cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.0.1/build/languages/bash.min.js defer></script>
<script src=//cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.0.1/build/languages/terraform.min.js defer></script>
<script src=//cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.0.1/build/languages/yaml.min.js defer></script>
<script src=//cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.0.1/build/languages/go.min.js defer></script>
<script src=//cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.0.1/build/languages/gradle.min.js defer></script>
<script src=//cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.0.1/build/languages/groovy.min.js defer></script>
<script src=//cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.0.1/build/languages/java.min.js defer></script>
<script src=//cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.0.1/build/languages/makefile.min.js defer></script>
<script src=//cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.0.1/build/languages/nginx.min.js defer></script>
<script src=//cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.0.1/build/languages/dockerfile.min.js defer></script>
<script>window.addEventListener('load',function(){hljs.highlightAll()},!0)</script>
<script src=//cdn.jsdelivr.net/npm/progressively@1.2.5/dist/progressively.min.js integrity="sha256-LvFVlLdfGI3WeEH+8Ni4kxLm02g2GlOfeGCGLXfRk/U=" crossorigin=anonymous></script>
<script>window.addEventListener('load',function(){progressively.init({delay:30,throttle:50})},!0)</script>
</body>
</html>